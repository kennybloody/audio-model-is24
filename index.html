<!doctype html>
<meta charset="utf-8">
<title>Костин Сергей</title>
<link rel="icon" type="image/png" href="logo.png">

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

<style>
:root{
  --accent:#5a2fff;     /* кнопки, выделения */
  --accent-hover:#9c7bff;
  --bg:#0c001a;         /* основной фон */
  --text:#e6e6e6;       /* текст */
  --muted:#888888;       /* приглушённый текст */
  --card:#15002d;        /* карточки, панели */
  --bar:#1c004a;         /* границы, линии */
}
*{box-sizing:border-box}
body{
  background:var(--bg);
  color:var(--text);
  font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}
/* ====== Шапка ====== */
header{
  background:#15002d;
  color:#e6e6e6;
  padding:28px 0;
  margin-bottom:18px;
  border-radius:12px;
}
header .container{
  max-width:1200px; margin:0 auto; padding:0 16px;
  display:flex; align-items:center; gap:16px
}
header img{
  height:clamp(90px, 10vw, 160px);
  width:auto; display:block;
}
header h1{margin:0; font-weight:800; letter-spacing:.02em; line-height:1.1}
header h1 small{display:block; color:#d1d5db; font-weight:600; font-size:16px}

/* ====== Контент ====== */
.container{max-width:1200px; margin:0 auto; padding:24px 16px 48px}
.grid{display:grid; grid-template-columns:360px 1fr; gap:22px}
.card{
  background:var(--card);
  border-radius:14px;
  box-shadow:0 6px 24px rgba(0,0,0,.3);
  padding:18px;
  overflow:hidden;
  border:1px solid var(--bar);
}
.card h3{margin:0 0 12px; font-size:18px}
.muted{color:#fff}

.btn{
  display:inline-flex; align-items:center; gap:8px;
  background:var(--accent);
  color:#fff;
  border:0;
  padding:10px 14px;
  border-radius:10px;
  cursor:pointer;
  font-weight:700;
  letter-spacing:.02em;
  transition: background 0.3s;
}
.btn.secondary{background:#333;}
.btn:disabled{opacity:.6; cursor:not-allowed}
.btn:hover{background:var(--accent-hover);}
 
.controls{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px}

.hint-box{
  background:#15002d;
  border:1px solid var(--bar);
  border-radius:12px;
  padding:12px 14px;
}
.hint-box .row{
  display:flex; align-items:center; gap:10px; flex-wrap:wrap;
}
.hint-box .label{min-width:140px; font-weight:700}
.hint-box input[type="range"]{width:200px}
.hint-box small{color:var(--muted);}
.hint-box b{color:#fff}

/* ====== Вердикт и вероятности ====== */
.verdict{
  margin:8px 0 14px; padding:10px 12px; border-radius:12px;
  background:#15002d; border:1px solid var(--bar);;
}
.verdict b{color:#fff}
.verdict .other{color:#ef4444}

.row-prob{display:flex; align-items:center; gap:10px; margin:6px 0}
.row-prob .label{width:120px; font-weight:600}
.row-prob .bar{position:relative; flex:1; height:16px; background:var(--bar);
              border-radius:999px; overflow:hidden}
.row-prob .bar > span{position:absolute; inset:0 auto 0 0; width:0%;
                     background:linear-gradient(90deg, var(--accent), #ff7d85)}
.row-prob .val{width:64px; text-align:right; font-variant-numeric:tabular-nums}
</style>

<header>
  <div class="container">
    <img src="./logo.png?v=1" alt="РАНХиГС">
    <h1>
      Информационные системы и программирование
      <small>Проверка аудио-модели (Teachable Machine)</small>
    </h1>
  </div>
</header>

<div class="container">
  <div class="grid">

    <!-- Левая колонка -->
    <div class="card">
      <h3>Ввод</h3>
      <div class="controls">
        <button id="btnStart" class="btn">Старт микрофона</button>
        <button id="btnStop" class="btn secondary" disabled>Стоп</button>
      </div>

      <div class="hint-box">
        <div class="row">
          <span class="label">Порог уверенности:</span>
          <input id="th" type="range" min="0.30" max="0.95" step="0.01" value="0.65">
          <b id="thVal">0.65</b>
        </div>
        <small>Если условия не выполняются — итогом будет <b>«Другое»</b>.</small>
      </div>
    </div>

    <!-- Правая колонка -->
    <div class="card">
      <h3>Результаты</h3>
      <div id="status" class="muted">Загрузка модели…</div>
      <div class="verdict" id="verdict" style="display:none"></div>
      <div id="probs"></div>
    </div>

  </div>
</div>

<script>
let recognizer;
let THRESHOLD = 0.65;
let listening = false;
const statusEl = document.getElementById('status');
const probsEl = document.getElementById('probs');
const verdictEl = document.getElementById('verdict');
const thSlider = document.getElementById('th');
const thVal = document.getElementById('thVal');
const btnStart = document.getElementById('btnStart');
const btnStop = document.getElementById('btnStop');

thSlider.addEventListener('input', e=>{
  THRESHOLD = Number(e.target.value);
  thVal.textContent = THRESHOLD.toFixed(2);
});

// Загрузка модели
async function loadModel() {
    recognizer = speechCommands.create(
        'BROWSER_FFT',
        undefined,
        'https://kennybloody.github.io/audio-model-is24/model.json',
        'https://kennybloody.github.io/audio-model-is24/metadata.json'
    );
    await recognizer.ensureModelLoaded();
    statusEl.textContent = 'Модель загружена. Нажмите "Запустить микрофон".';
}

// Запуск микрофона
btnStart.onclick = async () => {
  if (!recognizer || listening) return;
  try {
    await navigator.mediaDevices.getUserMedia({ audio:true });
    await recognizer.listen(result => {
      const scores = result.scores;
      const labels = recognizer.wordLabels();
      const preds = labels.map((l,i)=>({className:l, probability:scores[i]}));
      renderAudio(preds);
    }, { probabilityThreshold:0, overlapFactor:0.8 });
    listening = true;
    btnStart.disabled = true;
    btnStop.disabled = false;
    statusEl.textContent = 'Микрофон активен';
  } catch(e) {
    console.error(e);
    statusEl.textContent = 'Ошибка доступа к микрофону';
  }
};

// Остановка микрофона
btnStop.onclick = () => {
  if (recognizer && listening) {
    recognizer.stopListening();
    listening = false;
    btnStart.disabled = false;
    btnStop.disabled = true;
    statusEl.textContent = 'Микрофон остановлен';
  }
};

// Отображение результата
function renderAudio(preds) {
  probsEl.innerHTML = '';
  const sorted = [...preds].sort((a,b)=>b.probability-a.probability);
  const top1 = sorted[0];

  verdictEl.style.display = 'block';
  if (top1.probability < THRESHOLD) {
    verdictEl.innerHTML = `Итог: <b class="other">Другое</b> — уверенность ${(top1.probability*100).toFixed(1)}%`;
  } else {
    verdictEl.innerHTML = `Итог: <b>${top1.className}</b> — ${(top1.probability*100).toFixed(1)}%`;
  }

  preds.forEach(p=>{
    const row = document.createElement('div'); row.className='row-prob';
    const label = document.createElement('div'); label.className='label'; label.textContent=p.className;
    const bar = document.createElement('div'); bar.className='bar';
    const span = document.createElement('span'); span.style.width = `${(p.probability*100).toFixed(1)}%`;
    bar.appendChild(span);
    const val = document.createElement('div'); val.className='val'; val.textContent = `${(p.probability*100).toFixed(1)}%`;
    row.append(label, bar, val);
    probsEl.appendChild(row);
  });
}

loadModel();
</script>
